<meta-runner name="Cloudsmith Tag Package">
  <description>Cloudsmith Tag Package test</description>
  <settings>
    <parameters>
      <param name="CloudsmithUserName" spec="text description='Unused, only for keeping track of the CloudsmithApiKey account." />
      <param name="CloudsmithApiKey" spec="text description='API Key. The CloudSmith account needs to have Admin privilege on the target CloudSmith repository or the operation fails with a no permission error!' display='normal'" />
      <param name="CloudsmithRepoName" />
      <param name="CloudsmithUserName" />
      <param name="CloudsmithOrganisation" value="diligent" />
      <param name="PackageTag" value="Released" />
      <param name="PackageNames" spec="text description='Ordered, comma-separated list of package names.' display='normal'" />
      <param name="PackageVersions" spec="text description='Ordered, comma-separated list of package versions.' display='normal'" />
      <param name="PackageFormats" spec="text description='Ordered, comma-separated list of package formats.' display='normal'"/>
    </parameters>
    <build-runners>
      <runner name="" type="jetbrains_powershell">
        <parameters>
          <param name="jetbrains_powershell_execution" value="PS1" />
          <param name="jetbrains_powershell_noprofile" value="true" />
          <param name="jetbrains_powershell_script_code"><![CDATA[$apiKey = %env.CloudsmithApiKey%
$repo = %env.CloudsmithRepoName%
$packageNames = %PackageNames%
$packageVersions = %PackageVersions%
$packageFormats = %PackageFormats%
$packageTag = %PackageTag%

[Net.ServicePointManager]::SecurityProtocol = "Tls12, Ssl3"

$Headers = @{
	'X-APi-Key' = $apiKey
	'Accept'     = '*/*'
}
$packageIndex = 0

foreach ($packageName in $packageNames.Split(",")) {
    $packageVersion = $packageVersions.Split(",")[$packageIndex]
    $packageFormat = $packageFormats.Split(",")[$packageIndex]

    $query = "?query=name:$packageName AND version:$packageVersion AND format:$packageFormat"
    $packagesUrl = "https://api.cloudsmith.io/v1/packages/diligent/$repo"
    $search = "$PackagesUrl/$query"

    $pkg = invoke-restmethod -method GET -Uri $search -header $headers
    $id = $pkg.identifier_perm

    $headers.Set_Item('Content-Type','application/json')

    $tagSpec = @{
        tags         = @("$packageTag")
        action       = 'add'
        is_immutable = $true
    } | convertto-json -depth 5


    $tagUrl = " https://api.cloudsmith.io/v1/packages/diligent/$repo/$id/tag/"
    Write-Host "Writing tag for package $repo/$($packageName)-$($packageversion)"
    Write-Host "Tag Url:  $tagUrl"

    Invoke-RestMethod -method POST -uri $tagurl -body $tagSpec -header $headers
    $packageIndex++
}]]></param>
          <param name="jetbrains_powershell_script_mode" value="CODE" />
          <param name="org.jfrog.artifactory.selectedDeployableServer.downloadSpecSource" value="Job configuration" />
          <param name="org.jfrog.artifactory.selectedDeployableServer.uploadSpecSource" value="Job configuration" />
          <param name="org.jfrog.artifactory.selectedDeployableServer.useSpecs" value="false" />
          <param name="teamcity.step.mode" value="default" />
        </parameters>
      </runner>
    </build-runners>
    <requirements />
  </settings>
</meta-runner>