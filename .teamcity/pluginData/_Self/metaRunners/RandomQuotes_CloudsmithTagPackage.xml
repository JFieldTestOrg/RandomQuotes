<meta-runner name="Cloudsmith Tag Package">
  <description>Cloudsmith Tag Package test</description>
  <settings>
    <parameters>
      <param name="CloudsmithApiKey" spec="text description='API Key. The CloudSmith account needs to have Admin privilege on the target CloudSmith repository or the operation fails with a no permission error!' display='normal'" />
      <param name="CloudsmithRepoName" />     
      <param name="CloudsmithOrganisation" value="diligent" />
      <param name="Immutable" value="true" spec="text description='Tag property. Immutable tags only be modified or deleted by a user with repository admin privileges, or by the user that owns the package.' display='normal'"/>
      <param name="PackageTag" value="Released" />
      <param name="PackageNames" spec="text description='Ordered, comma-separated list of package names.' display='normal'" />
      <param name="PackageVersions" spec="text description='Ordered, comma-separated list of package versions.' display='normal'" />
      <param name="PackageFormat" spec="text description='Package format (E.g. nuget)' display='normal'"/>
    </parameters>
    <build-runners>
      <runner name="" type="jetbrains_powershell">
        <parameters>
          <param name="jetbrains_powershell_execution" value="PS1" />
          <param name="jetbrains_powershell_noprofile" value="true" />
          <param name="jetbrains_powershell_script_code"><![CDATA[

Write-Host "CloudSmith repository: %CloudsmithRepoName%"
$repo = "%CloudsmithRepoName%"
$packageNames = "%PackageNames%"
$packageVersions = "%PackageVersions%"
$packageFormat = "%PackageFormat%"
$packageTag = "%PackageTag%"

[Net.ServicePointManager]::SecurityProtocol = "Tls12"

$Headers = @{
	'X-APi-Key' = "%CloudsmithApiKey%"
	'Accept'     = '*/*'
}
$packageIndex = 0

foreach ($packageName in $packageNames.Split(",")) {
    $packageVersion = $packageVersions.Split(",")[$packageIndex]

    $query = "?query=name:$packageName AND version:$packageVersion AND format:$packageFormat"
    $packagesUrl = "https://api.cloudsmith.io/v1/packages/diligent/$repo"
    [string]$search = "$PackagesUrl/$query"

    Write-Host "Querying package info for $search"
    $pkg = invoke-restmethod -method GET -Uri $search -header $headers
    $id = $pkg.identifier_perm

    $headers.Set_Item('Content-Type','application/json')

    $tagSpec = @{
        tags         = @("$packageTag")
        action       = 'add'
        is_immutable = $true
    } | convertto-json -depth 5


    $tagUrl = " https://api.cloudsmith.io/v1/packages/diligent/$repo/$id/tag/"
    Write-Host "Writing tag for package $repo/$($packageName)-$($packageversion)"
    Write-Host "Tag Url:  $tagUrl"

    Invoke-RestMethod -method POST -uri $tagurl -body $tagSpec -header $headers
    $packageIndex++
}]]></param>
          <param name="jetbrains_powershell_script_mode" value="CODE" />
          <param name="org.jfrog.artifactory.selectedDeployableServer.downloadSpecSource" value="Job configuration" />
          <param name="org.jfrog.artifactory.selectedDeployableServer.uploadSpecSource" value="Job configuration" />
          <param name="org.jfrog.artifactory.selectedDeployableServer.useSpecs" value="false" />
          <param name="teamcity.step.mode" value="default" />
        </parameters>
      </runner>
    </build-runners>
    <requirements />
  </settings>
</meta-runner>